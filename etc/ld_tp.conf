server {
    listen       80;
    server_name  tp.lenovobee.com t.lenovobee.com;

    #charset koi8-r;

    #access_log  logs/host.access.log  main;
	root /opt/web/snail-bee/priv/www/;
    access_log  /opt/app/nginx/logs/tp.access.log;
    access_log  /opt/app/nginx/logs/tp.error.log;

	client_max_body_size 100g;
	location ~ \.xml$ {
		root /opt/web/snail-bee/priv/www/;
		index crossdomain.xml;
	}
	
    location / {
		proxy_http_version 1.1;
		proxy_pass http://tp.lenovobee.com:8080;
		proxy_set_header Host $host;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

	location /resource/upload/ {
		if ($request_method = OPTIONS) {
			add_header Access-Control-Allow-Origin  *;
			add_header Access-Control-Allow-Method  POST;
			return 200;
		}
		auth_request /auth;
		
		auth_request_set $cowboy_respon $upstream_http_x_snail_status;
		auth_request_set $cowboy_error  $upstream_http_x_cowboy_error;
		add_header x-snail-msg $cowboy_respon;
		add_header x-snail-error $cowboy_error;

		client_max_body_size 100g;


		# Pass altered request body to this location
		upload_pass @upload;

		#upload_pass_args on;
		
		# Store files to this directory
		# The directory is hashed, subdirectories 0 1 2 3 4 5 6 7 8 9 should exist
		upload_store /opt/data/tmp/nginx 1;
		
		# Allow uploaded files to be read only by user
		#upload_store_access user:r;
		
		# Set specified fields in request body
		upload_set_form_field $upload_field_name.name "$upload_file_name";
		upload_set_form_field $upload_field_name.content_type "$upload_content_type";
		upload_set_form_field $upload_field_name.path "$upload_tmp_path";
		upload_set_form_field $upload_field_name.orignal_uri "$request_uri";
		
		# Inform backend about hash and size of a file
		upload_aggregate_form_field "$upload_field_name.md5" "$upload_file_md5";
		upload_aggregate_form_field "$upload_field_name.size" "$upload_file_size";
		
		upload_pass_form_field "^submit$|^description$";
		
		upload_cleanup 400 404 499 500-505;
		
		#track_uploads uploads 5s;
	}

	location @upload {
		internal;
		proxy_http_version 1.1;
		proxy_pass http://tp.lenovobee.com:8080;
	}

	location  /auth {
		internal;
		proxy_pass http://tp.lenovobee.com:8080;
		proxy_pass_request_body off;
		proxy_set_header Content-Length "";
		proxy_set_header X-Original-URI $request_uri;
	}

	
#	location /resource/uploadblock {
#        proxy_pass http://tp.lenovobee.com:8080;
#        proxy_set_header Host $host;
#        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#    }
#	location /resource/downloadblock/ {
#		#proxy_http_version 1.1;
#		proxy_pass http://tp.lenovobee.com:8080;
#        proxy_set_header Host $host;
#        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#	}

	#download 还需要利用cowboy执行X-accl-redirect到此
	location /data {
		alias /opt/data/;	#这个同时也是snail里面的数据路径的前缀
	}

    #error_page  404              /404.html;
    #error_page   500 502 503 504  /50x.html;
    #location = /50x.html {
    #    root   html;
    #}

    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
    #
    #location ~ \.php$ {
    #    fastcgi_pass   unix:/tmp/php.socket;
    #    fastcgi_index  index.php;
    #    include        fastcgi.conf;
    #}
}
